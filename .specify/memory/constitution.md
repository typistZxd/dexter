<!--
同步影响报告
==============
版本变更: 无 → 1.0.0 (初始版本)
新增原则:
  - I. 代理优先架构
  - II. 工具可组合性
  - III. 自主与可控
  - IV. 数据驱动决策
  - V. 用户体验优先
新增章节:
  - 核心原则
  - 技术约束
  - 开发流程
  - 治理
模板更新状态:
  ✅ plan-template.md - 已验证兼容
  ✅ spec-template.md - 已验证兼容
  ✅ tasks-template.md - 已验证兼容
待办事项: 无
-->

# Dexter 项目宪法

## 核心原则

### I. 代理优先架构

所有功能设计必须围绕代理（Agent）能力展开。核心要求：

- **任务分解能力**: 复杂金融问题必须能被分解为结构化的研究步骤
- **工具调用能力**: 代理必须能够选择并执行正确的工具来获取数据
- **自我反思能力**: 代理必须能检查自身工作并迭代优化结果
- **上下文感知**: 代理必须维护对话历史和执行状态的感知

**原理**: Dexter 的核心价值在于其自主研究能力，所有功能扩展都必须增强而非削弱这一能力。

### II. 工具可组合性

金融工具必须遵循模块化设计原则：

- **独立性**: 每个工具必须是独立的、可单独测试的模块
- **统一接口**: 所有工具必须通过 `registry.ts` 统一注册，遵循 `tools/types.ts` 定义的类型
- **清晰描述**: 每个工具必须在 `tools/descriptions/` 中提供清晰的功能描述，供代理理解和选择
- **数据标准化**: 工具返回的数据必须是结构化的，便于代理解析和使用

**原理**: 模块化设计使得扩展新的数据源和分析能力变得简单可靠。

### III. 自主与可控

代理执行必须在安全边界内进行：

- **循环检测**: 必须实现循环检测机制，防止无限执行
- **步骤限制**: 必须设置最大执行步骤，防止资源耗尽
- **错误恢复**: 工具调用失败必须有合理的降级策略
- **执行透明**: 代理的思考过程和决策必须对用户可见

**原理**: 自主性是核心价值，但不可控的自主性是危险的。安全机制是底线，不可妥协。

### IV. 数据驱动决策

所有金融分析必须基于实时数据：

- **数据新鲜度**: 优先使用实时市场数据，明确标注数据时间戳
- **数据来源**: 必须使用可靠的数据提供商（Financial Datasets API）
- **数据验证**: 异常数据必须进行合理性检查
- **不可臆测**: 代理不得编造或猜测金融数据，缺失数据必须明确告知用户

**原理**: 金融研究的价值在于准确性，错误的数据比没有数据更危险。

### V. 用户体验优先

CLI 界面必须简洁、直观、高效：

- **响应式反馈**: 长时间操作必须提供进度指示
- **清晰输出**: 使用 React/Ink 组件化构建 UI，保持视觉一致性
- **错误友好**: 错误信息必须清晰说明问题和建议的解决方案
- **交互流畅**: 输入历史、模型选择等功能必须符合用户直觉

**原理**: 优秀的工具不仅功能强大，更要让用户愿意使用。

## 技术约束

### 技术栈要求

- **运行时**: Bun v1.0+（利用其原生 TypeScript 支持和高性能）
- **语言**: TypeScript（严格模式，充分利用类型系统）
- **UI 框架**: React + Ink（CLI 组件化）
- **AI 框架**: LangChain（统一的 LLM 接口）
- **验证**: Zod（运行时类型验证）

### 目录结构约定

```
src/
├── agent/       # 代理核心逻辑（任务规划、执行、反思）
├── components/  # React/Ink UI 组件
├── hooks/       # React 自定义 Hooks
├── model/       # LLM 配置和实例化
├── tools/       # 工具实现（金融、搜索等）
│   ├── descriptions/  # 工具描述（供代理理解）
│   ├── finance/       # 金融数据工具
│   └── search/        # 搜索工具（Exa、Tavily）
└── utils/       # 通用工具函数
```

### 代码风格

- 组件文件使用 `.tsx` 扩展名，纯逻辑文件使用 `.ts`
- 每个模块通过 `index.ts` 导出公共 API
- 使用函数式组件和 Hooks，避免类组件
- 优先使用组合而非继承

## 开发流程

### 功能开发

1. **需求明确**: 新功能必须明确其如何增强代理能力或用户体验
2. **设计先行**: 复杂功能需先在 `/specs/` 目录创建规格文档
3. **增量实现**: 按用户故事优先级逐步实现，每个故事可独立测试
4. **代码审查**: 提交前确保类型检查通过（`bun run typecheck`）

### 测试策略

- **单元测试**: 关键工具和工具函数必须有单元测试
- **集成测试**: 代理端到端流程需要集成测试覆盖
- **手动验证**: UI 交互需要手动验证用户体验

### 提交规范

- 提交信息简洁明了，说明变更的"为什么"而非"是什么"
- 保持 PR 小而聚焦，便于审查
- 分支命名: `feat/YYMMDD/feature-name` 或 `fix/YYMMDD/issue-description`

## 治理

### 宪法效力

本宪法是 Dexter 项目的最高指导原则。所有设计决策、代码审查、功能开发都必须符合宪法规定。

### 修订程序

1. 提出修订提案，说明修订原因和预期影响
2. 评估修订对现有代码和文档的影响
3. 更新宪法版本号（遵循语义化版本）
4. 同步更新所有受影响的模板和文档

### 版本策略

- **MAJOR**: 删除或重新定义核心原则
- **MINOR**: 新增原则/章节或实质性扩展现有指导
- **PATCH**: 澄清、措辞修正、非语义性改进

### 合规检查

- 每次 PR 审查必须验证是否符合核心原则
- 复杂性必须有充分理由，默认选择简单方案
- 开发过程中的具体指导参见本宪法及相关模板

**Version**: 1.0.0 | **Ratified**: 2026-01-25 | **Last Amended**: 2026-01-25
